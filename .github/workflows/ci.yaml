name: Prepare server (reusable)

on:
  workflow_call:

jobs:
  preparing:
    runs-on: prepare-runner
    steps:
      - name: preparing server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_DOMAIN_NAME: ${{ secrets.SERVER_DOMAIN_NAME }}
          PREPARING_HOST_NAME: ${{ secrets.PREPARING_HOST_NAME }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          SSH_KEY_PATH="$HOME/.ssh/deploy_key"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"

          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SERVER_DOMAIN_NAME" >> ~/.ssh/known_hosts

          ssh -p "${SSH_PORT:-22}" \
            -i "$SSH_KEY_PATH" \
            -o IdentitiesOnly=yes \
            "${PREPARING_HOST_NAME}@${SERVER_DOMAIN_NAME}" \
            "/opt/github_k3s_runners/update_repo_url.sh '${{ github.server_url }}' '${{ github.repository }}'"
